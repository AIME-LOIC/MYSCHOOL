<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta name="google-site-verification" content="ZfOqpsVV7Mv1-PxcKiUDQBBONWc1SKmeTi2y2OnZ_RY" />
    <style>
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        .blur-bg { filter: blur(4px); pointer-events: none; transition: filter 0.3s ease; }
        
        /* Toast Animations */
        @keyframes slideUp {
            from { 
                opacity: 0; 
                transform: translateY(30px) translateX(-50%);
            }
            to { 
                opacity: 1; 
                transform: translateY(0) translateX(-50%);
            }
        }
        
        @keyframes slideDown {
            from { 
                opacity: 1; 
                transform: translateY(0) translateX(-50%);
            }
            to { 
                opacity: 0; 
                transform: translateY(30px) translateX(-50%);
            }
        }
        
        .toast-enter { animation: slideUp 0.4s ease-out forwards; }
        .toast-exit { animation: slideDown 0.4s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="delete-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="fixed inset-0 bg-black/40" onclick="closeDeleteModal()"></div>
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full relative z-10 animate-fade-in">
            <div class="text-center">
                <div class="bg-red-100 text-red-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Are you sure?</h3>
                <p id="modal-text" class="text-gray-500 text-sm mb-6">This action cannot be undone. This will permanently delete the selected student(s).</p>
                <div class="flex gap-3">
                    <button onclick="closeDeleteModal()" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 font-semibold rounded-lg hover:bg-gray-200 transition">Cancel</button>
                    <button id="confirm-delete-btn" class="flex-1 px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition shadow-lg shadow-red-200">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <div id="loading-page" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50 transition-opacity duration-500">
        <div class="text-center">
            <svg class="animate-spin h-12 w-12 text-blue-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-gray-600 text-lg font-medium">Initializing Dashboard...</p>
        </div>
    </div>

    <div id="main-content" class="container mx-auto p-4 md:p-8 pt-12 hidden">
        <header id="header-area" class="mb-8 text-center md:text-left">
            <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight">
                <span class="text-blue-600">A</span>dmin <span class="text-blue-600">D</span>ashboard
            </h1>
            <p class="text-gray-500 mt-1">Attendance tracking and student database management.</p>
        </header>

        <div id="choice-step" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 animate-fade-in">
            <h3 class="text-xl font-semibold mb-5 text-gray-700">Main Menu:</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <button onclick="selectType('visit_day')" class="py-4 px-6 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition shadow-md">Visit Day Data</button>
                <button onclick="selectType('parent_meeting')" class="py-4 px-6 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition shadow-md">Parent Meeting Data</button>
                <button onclick="openManager()" class="py-4 px-6 bg-gray-800 hover:bg-black text-white font-bold rounded-lg transition shadow-md flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    Manage Students
                </button>
                <button onclick="openLiveTrack()" class="py-4 px-6 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition shadow-md flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    Live Track
                </button>
                <button id="btn-car-management" onclick="openCarManagement()" class="py-4 px-6 bg-amber-600 hover:bg-amber-700 text-white font-bold rounded-lg transition shadow-md">
                    Car Management
                </button>
            </div>
        </div>

        <div id="manager-step" class="hidden mt-8 animate-fade-in space-y-6">
            <div class="flex justify-between items-center">
                <button onclick="resetSelection()" class="flex items-center py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium transition">‚Üê Back</button>
                <button id="bulk-delete-btn" onclick="askBulkDelete()" class="hidden py-2 px-4 bg-red-50 text-red-600 rounded-lg hover:bg-red-600 hover:text-white font-bold transition flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    Delete Selected (<span id="selected-count">0</span>)
                </button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h4 class="text-lg font-bold text-gray-800 mb-4">Add Single Student</h4>
                        <div class="space-y-3">
                            <input type="text" id="Student_name" placeholder="Full Name" class="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            <input type="text" id="class_name" placeholder="Class (e.g. S1A)" class="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            <button onclick="addSingleStudent()" class="w-full bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition">Add Student</button>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h4 class="text-lg font-bold text-gray-800 mb-4">Bulk Upload (Excel)</h4>
                        <input type="file" id="excel-file-manager" accept=".xlsx" class="w-full text-xs text-gray-500 mb-4">
                        <button onclick="uploadStudents('manager')" class="w-full bg-green-600 text-white py-2 rounded-lg font-bold hover:bg-green-700 transition">Upload File</button>
                        <p id="manager-upload-feedback" class="mt-2 text-xs font-medium"></p>
                    </div>
                </div>

                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                        <div class="p-4 border-b bg-gray-50 flex flex-col sm:flex-row justify-between items-center gap-4">
                            <h3 class="text-xl font-bold text-gray-800">Student Directory</h3>
                            <select id="class-filter" onchange="filterStudentsByClass()" class="border rounded-lg px-3 py-1.5 text-sm bg-white outline-none">
                                <option value="all">All Classes</option>
                            </select>
                        </div>
                        <div class="overflow-x-auto max-h-[600px] custom-scrollbar">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-6 py-3 text-left w-10">
                                            <input type="checkbox" id="select-all-checkbox" onchange="toggleAllSelection()" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Class</th>
                                        <th class="px-6 py-3 text-right text-xs font-semibold text-gray-500 uppercase">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="manager-student-list" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="data-step" class="hidden mt-8 animate-fade-in">
            <button onclick="resetSelection()" class="flex items-center mb-6 py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium transition">‚Üê Back</button>
            <h3 id="data-title" class="text-3xl font-bold mb-6"></h3>
            <div id="stats-area" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 space-y-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                        <h4 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Overview Statistics</h4>
                        <div id="stats" class="grid grid-cols-2 gap-4 text-gray-600"></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                         <h4 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Attendance By Class</h4>
                        <canvas id="classChart" class="w-full"></canvas>
                    </div>
                </div>
                <div id="classes-container" class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border border-gray-200 max-h-[80vh] overflow-y-auto custom-scrollbar">
                </div>
            </div>
        </div>

        <div id="live-track-step" class="hidden mt-8 animate-fade-in">
            <button onclick="resetSelection()" class="flex items-center mb-6 py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium transition">‚Üê Back</button>
            <h3 class="text-3xl font-bold mb-6">Live Track - Real-time Attendance</h3>
            
            <!-- Type Selection Tabs -->
            <div class="flex gap-4 mb-6">
                <button onclick="setLiveTrackType('visit_day')" id="btn-visit-day" class="py-3 px-6 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition shadow-md">Visit Day</button>
                <button onclick="setLiveTrackType('parent_meeting')" id="btn-parent-meeting" class="py-3 px-6 bg-gray-400 text-white font-bold rounded-lg hover:bg-gray-500 transition shadow-md">Parent Meeting</button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
                <select id="live-class-filter" onchange="filterLiveByClass()" class="border rounded-lg px-3 py-2 bg-white outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="all">All Classes</option>
                </select>
                <input type="text" id="live-search" placeholder="Search by name..." onkeyup="filterLiveBySearch()" class="border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="refreshLiveData()" class="py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-bold">Refresh</button>
                <button onclick="toggleAutoRefresh()" class="py-2 px-4 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-bold" id="auto-refresh-btn">Start Auto-Refresh</button>
            </div>
            <div id="live-table-container" class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="px-6 py-3 text-left text-sm font-bold text-gray-700">Student Name</th>
                            <th class="px-6 py-3 text-left text-sm font-bold text-gray-700">Class</th>
                            <th class="px-6 py-3 text-left text-sm font-bold text-gray-700">Visit Type</th>
                            <th class="px-6 py-3 text-left text-sm font-bold text-gray-700">Date</th>
                            <th class="px-6 py-3 text-left text-sm font-bold text-gray-700">Status</th>
                        </tr>
                    </thead>
                    <tbody id="live-data-list" class="divide-y">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="car-management-step" class="hidden mt-8 animate-fade-in">
            <button onclick="resetSelection()" class="flex items-center mb-6 py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium transition">‚Üê Back</button>
            <h3 class="text-3xl font-bold mb-6">Car Management</h3>

            <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-200 mb-4">
                <div class="flex flex-col md:flex-row gap-3 items-start md:items-center">
                    <select id="car-visit-type" onchange="loadCarManagementData()" class="border rounded-lg px-3 py-2 bg-white outline-none focus:ring-2 focus:ring-amber-500">
                        <option value="visit_day">Visit Day</option>
                        <option value="parent_meeting">Parent Meeting</option>
                    </select>
                    <input id="car-visit-date" type="date" onchange="loadCarManagementData()" class="border rounded-lg px-3 py-2 bg-white outline-none focus:ring-2 focus:ring-amber-500">
                    <button onclick="loadCarManagementData()" class="py-2 px-4 bg-amber-600 text-white rounded-lg hover:bg-amber-700 transition font-bold">Refresh</button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-bold text-gray-700">Student</th>
                            <th class="px-4 py-3 text-left text-sm font-bold text-gray-700">Class</th>
                            <th class="px-4 py-3 text-left text-sm font-bold text-gray-700">Movement</th>
                            <th class="px-4 py-3 text-left text-sm font-bold text-gray-700">Arrival Plate</th>
                            <th class="px-4 py-3 text-left text-sm font-bold text-gray-700">Assigned Plate</th>
                            <th class="px-4 py-3 text-left text-sm font-bold text-gray-700">Action</th>
                        </tr>
                    </thead>
                    <tbody id="car-management-list" class="divide-y"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-8 left-1/2 hidden z-50 px-6 py-4 rounded-lg shadow-2xl font-semibold text-white whitespace-nowrap flex items-center gap-3">
        <svg id="toast-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"></svg>
        <span id="toast-message">Message</span>
    </div>

    <script>
        let allStudents = [];
        let selectedIds = new Set();
        let chartInstance = null;
        let toastTimeout = null;
        
        // Extract school name from URL path
        const schoolName = window.location.pathname.split('/')[1];
        const schoolCode = "{{ school_code }}";
        const isSOSSchool = (schoolCode || '').trim().toLowerCase() === 'sos' || (schoolName || '').trim().toLowerCase().includes('sos');

        // --- TOAST NOTIFICATION LOGIC ---
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const msg = document.getElementById('toast-message');
            
            msg.innerText = message;
            
            if (type === 'success') {
                toast.classList.remove('bg-red-500');
                toast.classList.add('bg-green-500');
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>';
            } else if (type === 'error') {
                toast.classList.remove('bg-green-500');
                toast.classList.add('bg-red-500');
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>';
            }
            
            toast.classList.remove('hidden', 'toast-exit');
            toast.classList.add('toast-enter');
            
            if (toastTimeout) clearTimeout(toastTimeout);
            
            toastTimeout = setTimeout(() => {
                toast.classList.remove('toast-enter');
                toast.classList.add('toast-exit');
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 400);
            }, 3500);
        }

        window.onload = () => {
            setTimeout(() => {
                document.getElementById('loading-page').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                if (!isSOSSchool) {
                    document.getElementById('btn-car-management')?.classList.add('hidden');
                }
            }, 1000);
        };

        // --- UI MODAL LOGIC ---
        function showDeleteModal(onConfirm, text) {
            document.getElementById('main-content').classList.add('blur-bg');
            document.getElementById('delete-modal').classList.remove('hidden');
            document.getElementById('modal-text').innerText = text || "This action cannot be undone. This will permanently delete the selected record(s).";
            const btn = document.getElementById('confirm-delete-btn');
            // Remove old listeners to prevent double-firing
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.addEventListener('click', () => {
                onConfirm();
                closeDeleteModal();
            });
        }

        function closeDeleteModal() {
            document.getElementById('main-content').classList.remove('blur-bg');
            document.getElementById('delete-modal').classList.add('hidden');
        }

        function resetSelection() {
            document.getElementById('data-step').classList.add('hidden');
            document.getElementById('manager-step').classList.add('hidden');
            document.getElementById('live-track-step').classList.add('hidden');
            document.getElementById('car-management-step').classList.add('hidden');
            document.getElementById('choice-step').classList.remove('hidden');
        }

        // --- MANAGER LOGIC ---
        async function openManager() {
            document.getElementById('choice-step').classList.add('hidden');
            document.getElementById('manager-step').classList.remove('hidden');
            await loadAllStudents();
        }

        async function loadAllStudents() {
            const list = document.getElementById('manager-student-list');
            list.innerHTML = '<tr><td colspan="4" class="px-6 py-10 text-center text-blue-500">Loading database...</td></tr>';
            try {
                const res = await fetch(`/${schoolName}/admin/students`);
                const result = await res.json();
                if (result.status === "success") {
                    allStudents = result.students;
                    updateClassFilterDropdown();
                    renderStudentTable(allStudents);
                    updateBulkUI();
                }
            } catch (err) { list.innerHTML = '<tr><td colspan="4" class="text-red-500 text-center">Connection Error.</td></tr>'; }
        }

        function renderStudentTable(students) {
            const list = document.getElementById('manager-student-list');
            list.innerHTML = students.length ? '' : '<tr><td colspan="4" class="px-6 py-10 text-center text-gray-400">No records found.</td></tr>';
            
            students.forEach(s => {
                const isChecked = selectedIds.has(s.id);
                const row = document.createElement('tr');
                row.className = `hover:bg-blue-50 transition ${isChecked ? 'bg-blue-50' : ''}`;
                row.innerHTML = `
                    <td class="px-6 py-4">
                        <input type="checkbox" onchange="toggleSelect(${s.id})" ${isChecked ? 'checked' : ''} class="rounded border-gray-300 text-blue-600">
                    </td>
                    <td class="px-6 py-4 text-sm font-bold text-gray-900">${s.student_name}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${s.class_name}</td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="askSingleDelete(${s.id}, '${s.student_name}')" class="text-red-500 hover:text-red-700 font-bold px-2 py-1">Delete</button>
                    </td>
                `;
                list.appendChild(row);
            });
        }

        // --- SELECTION LOGIC ---
        function toggleSelect(id) {
            if (selectedIds.has(id)) selectedIds.delete(id);
            else selectedIds.add(id);
            updateBulkUI();
            renderStudentTable(allStudents); // Re-render to show background color
        }

        function toggleAllSelection() {
            const isAllChecked = document.getElementById('select-all-checkbox').checked;
            if (isAllChecked) allStudents.forEach(s => selectedIds.add(s.id));
            else selectedIds.clear();
            updateBulkUI();
            renderStudentTable(allStudents);
        }

        function updateBulkUI() {
            const count = selectedIds.size;
            const btn = document.getElementById('bulk-delete-btn');
            document.getElementById('selected-count').innerText = count;
            if (count > 0) btn.classList.remove('hidden');
            else btn.classList.add('hidden');
        }

        // --- DELETE ACTIONS ---
        function askSingleDelete(id, name) {
            showDeleteModal(() => executeDelete([id]), `Are you sure you want to delete ${name}? This will remove all their records from the system.`);
        }

        function askBulkDelete() {
            const count = selectedIds.size;
            showDeleteModal(() => executeDelete(Array.from(selectedIds)), `Are you sure you want to delete ${count} selected students? This action is permanent.`);
        }

        async function executeDelete(ids) {
            try {
                await Promise.all(ids.map(id => fetch(`/${schoolName}/admin/students/${id}`, {method:'DELETE'})));
                selectedIds.clear();
                loadAllStudents();
            } catch (err) { showToast("Delete failed. Check connection.", "error"); }
        }

        // --- UTILS ---
        function updateClassFilterDropdown() {
            const dropdown = document.getElementById('class-filter');
            const classes = [...new Set(allStudents.map(s => s.class_name))].sort();
            dropdown.innerHTML = '<option value="all">All Classes</option>';
            classes.forEach(c => dropdown.innerHTML += `<option value="${c}">${c}</option>`);
        }

        function filterStudentsByClass() {
            const val = document.getElementById('class-filter').value;
            const filtered = val === "all" ? allStudents : allStudents.filter(s => s.class_name === val);
            renderStudentTable(filtered);
        }

       async function addSingleStudent() {
    const nameInput = document.getElementById('Student_name');
    const classInput = document.getElementById('class_name');
    
    const studentName = nameInput.value.trim();
    const className = classInput.value.trim();

    if (!studentName || !className) {
        showToast("Please enter both Name and Class.", "error");
        return;
    }

    // Create FormData object to match FastAPI Form(...) requirements
    const formData = new FormData();
    formData.append('student_name', studentName);
    formData.append('class_name', className);

    try {
        const res = await fetch(`/${schoolName}/admin/add_student`, {
            method: 'POST',
            body: formData // Sending as FormData, not JSON
        });

        const result = await res.json();

        if (result.status === "success") {
            // Clear inputs
            nameInput.value = '';
            classInput.value = '';
            
            // Refresh the table to show the new student
            await loadAllStudents();
            
            // Optional: Provide feedback
            console.log("Student added:", result.student_id);
            showToast("Student added successfully.", "success");
        } else {
            showToast(result.message || "Could not add student.", "error");
        }
    } catch (err) {
        console.error(err);
        showToast("Connection error. Could not add student.", "error");
    }
}

        async function uploadStudents(source) {
            const inputId = source === 'manager' ? 'excel-file-manager' : 'excel-file';
            const feedback = document.getElementById('manager-upload-feedback');
            const fileInput = document.getElementById(inputId);
            if(!fileInput.files.length) return;
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            try {
                const res = await fetch(`/${schoolName}/admin/upload-students`, { method: 'POST', body: formData });
                if((await res.json()).status === "success") loadAllStudents();
            } catch (err) { feedback.innerText = "Error uploading."; }
        }

        function selectType(type) {
            selectedType = type;
            document.getElementById('choice-step').classList.add('hidden');
            document.getElementById('data-step').classList.remove('hidden');
            document.getElementById('data-title').innerText = type === 'visit_day' ? "Visit Day Data" : "Parent Meeting Data";
            fetchData();
        }

        async function fetchData() {
            const statsDiv = document.getElementById('stats');
            const container = document.getElementById('classes-container');
            statsDiv.innerHTML = 'Loading...';
            try {
                const res = await fetch(`/${schoolName}/admin/data/${selectedType}`);
                const result = await res.json();
                statsDiv.innerHTML = `<div class="p-3 bg-gray-50 border rounded text-center"><p class="text-xs uppercase font-bold text-gray-400">Total</p><p class="text-2xl font-black">${result.total}</p></div>`;
                container.innerHTML = '<h4 class="text-xl font-bold mb-4">Class Detail (Newest First)</h4>';
                for (const cls in result.data) {
                    const div = document.createElement('div');
                    div.className = "mb-4 p-4 bg-white border rounded shadow-sm";
                    div.innerHTML = `<h5 class="font-bold border-b mb-2">${cls}</h5>`;
                    // Sort by date - newest first
                    const sorted = result.data[cls].sort((a, b) => new Date(b.date) - new Date(a.date));
                    sorted.forEach(s => div.innerHTML += `<div class="flex justify-between text-xs py-1"><span>${s.student_name}</span><span class="text-gray-400">${s.date}</span></div>`);
                    container.appendChild(div);
                }
                drawChart(result.stats);
            } catch(err) { statsDiv.innerHTML = "Error."; }
        }

        function drawChart(stats) {
            const ctx = document.getElementById('classChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(stats),
                    datasets: [{
                        label: 'Records',
                        data: Object.values(stats),
                        backgroundColor: '#2563eb',
                        borderRadius: 4
                    }]
                }
            });
        }

      // --- LIVE TRACK LOGIC (FIXED - TRUE FIFO WITH ID FALLBACK) ---
        let liveTrackData = [];
        let filteredLiveData = [];
        let autoRefreshInterval = null;
        let isAutoRefreshEnabled = false;
        let currentLiveTrackType = 'visit_day';
        let previousDataCount = 0;
        let previousDataString = '';
        let carManagementData = [];

        async function openLiveTrack() {
            document.getElementById('choice-step').classList.add('hidden');
            document.getElementById('live-track-step').classList.remove('hidden');
            currentLiveTrackType = 'visit_day';
            updateLiveTrackTypeButtons();
            previousDataCount = 0;
            previousDataString = '';
            await refreshLiveData();
        }

        function setLiveTrackType(type) {
            currentLiveTrackType = type;
            updateLiveTrackTypeButtons();
            filterLiveByClass();
        }

        function updateLiveTrackTypeButtons() {
            const visitDayBtn = document.getElementById('btn-visit-day');
            const pmBtn = document.getElementById('btn-parent-meeting');
            
            if (currentLiveTrackType === 'visit_day') {
                visitDayBtn.classList.remove('bg-gray-400', 'hover:bg-gray-500');
                visitDayBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                pmBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                pmBtn.classList.add('bg-gray-400', 'hover:bg-gray-500');
            } else {
                visitDayBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                visitDayBtn.classList.add('bg-gray-400', 'hover:bg-gray-500');
                pmBtn.classList.remove('bg-gray-400', 'hover:bg-gray-500');
                pmBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            }
        }

        async function refreshLiveData() {
            const container = document.getElementById('live-data-list');
            
            try {
                const students = await fetch(`/${schoolName}/admin/students`).then(r => r.json()).then(r => r.students || []);
                const studentMap = Object.fromEntries(students.map(s => [s.id, s]));
                
                // Fetch data for current type
                const dataRes = await fetch(`/${schoolName}/admin/data/${currentLiveTrackType}`);
                const data = await dataRes.json();
                
                // Get today's date
                const today = new Date().toISOString().split('T')[0];
                
                // Collect ALL visits from ALL classes
                const allVisits = [];
                
                for (const cls in data.data) {
                    data.data[cls].forEach((visit) => {
                        // Only show today's visits
                        if (visit.date === today) {
                            const student = Object.values(studentMap).find(s => s.student_name === visit.student_name);
                            if (student) {
                                const typeLabel = currentLiveTrackType === 'visit_day' ? 'Visit Day' : 'Parent Meeting';
                                allVisits.push({
                                    student_name: visit.student_name,
                                    class_name: student.class_name,
                                    visit_type: typeLabel,
                                    visit_date: visit.date,
                                    timestamp: visit.timestamp, // From backend
                                    id: visit.id, // Database ID for ordering
                                    status: 'Recorded'
                                });
                            }
                        }
                    });
                }
                
                // FIFO Sort: Use timestamp if available, otherwise use ID (database insertion order)
                allVisits.sort((a, b) => {
                    // If both have timestamps, use them
                    if (a.timestamp && b.timestamp) {
                        return new Date(a.timestamp) - new Date(b.timestamp);
                    }
                    // If no timestamps, use ID (lower ID = earlier insertion = FIFO)
                    return (a.id || 0) - (b.id || 0);
                });
                
                liveTrackData = allVisits;
                
                // Create a string representation of the data to compare
                const currentDataString = JSON.stringify(liveTrackData);
                
                // Check if data has changed
                if (currentDataString !== previousDataString || liveTrackData.length !== previousDataCount) {
                    previousDataString = currentDataString;
                    previousDataCount = liveTrackData.length;
                    
                    // Check for duplicate visits today
                    const visitCounts = {};
                    liveTrackData.forEach(record => {
                        const key = `${record.student_name}-${record.visit_date}`;
                        visitCounts[key] = (visitCounts[key] || 0) + 1;
                    });
                    
                    filteredLiveData = liveTrackData.map(record => ({
                        ...record,
                        isDuplicate: visitCounts[`${record.student_name}-${record.visit_date}`] > 1
                    }));
                    
                    updateLiveClassFilter();
                    renderLiveTrackTable();
                    showToast(`üìç New arrival! Total: ${liveTrackData.length} record${liveTrackData.length !== 1 ? 's' : ''} today.`, 'success');
                } else if (isAutoRefreshEnabled) {
                    // No new data during auto-refresh, don't show toast
                    updateLiveClassFilter();
                    renderLiveTrackTable();
                }
            } catch (err) {
                console.error(err);
                container.innerHTML = '<tr><td colspan="5" class="px-6 py-10 text-center text-red-500">Error loading data. Check connection.</td></tr>';
                showToast('Failed to load data. Please check your connection.', 'error');
            }
        }

        function renderLiveTrackTable() {
            const list = document.getElementById('live-data-list');
            if (filteredLiveData.length === 0) {
                list.innerHTML = '<tr><td colspan="5" class="px-6 py-10 text-center text-gray-400">No records found.</td></tr>';
                return;
            }
            
            list.innerHTML = '';
            filteredLiveData.forEach((record, index) => {
                const row = document.createElement('tr');
                const bgClass = record.isDuplicate ? 'bg-red-50 hover:bg-red-100' : 'hover:bg-blue-50';
                row.className = `${bgClass} transition`;
                const statusColor = record.isDuplicate ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700';
                const statusText = record.isDuplicate ? '‚ö†Ô∏è Multiple' : record.status;
                
                // Add position indicator for FIFO
                const positionBadge = `<span class="text-xs text-gray-400 mr-2">#${index + 1}</span>`;
                
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm font-bold ${record.isDuplicate ? 'text-red-900' : 'text-gray-900'}">${positionBadge}${record.student_name}</td>
                    <td class="px-6 py-4 text-sm ${record.isDuplicate ? 'text-red-600' : 'text-gray-600'}">${record.class_name}</td>
                    <td class="px-6 py-4 text-sm ${record.isDuplicate ? 'text-red-600' : 'text-gray-600'}">${record.visit_type}</td>
                    <td class="px-6 py-4 text-sm ${record.isDuplicate ? 'text-red-500' : 'text-gray-500'}">${record.visit_date}</td>
                    <td class="px-6 py-4 text-sm"><span class="${statusColor} px-3 py-1 rounded-full text-xs font-bold">${statusText}</span></td>
                `;
                list.appendChild(row);
            });
        }

        function updateLiveClassFilter() {
            const dropdown = document.getElementById('live-class-filter');
            const classes = [...new Set(liveTrackData.map(r => r.class_name))].sort();
            dropdown.innerHTML = '<option value="all">All Classes</option>';
            classes.forEach(c => dropdown.innerHTML += `<option value="${c}">${c}</option>`);
        }

        function filterLiveByClass() {
            const selectedClass = document.getElementById('live-class-filter').value;
            const searchTerm = document.getElementById('live-search').value.toLowerCase();
            
            filteredLiveData = liveTrackData.filter(record => {
                const matchClass = selectedClass === 'all' || record.class_name === selectedClass;
                const matchSearch = searchTerm === '' || record.student_name.toLowerCase().includes(searchTerm);
                return matchClass && matchSearch;
            });
            
            renderLiveTrackTable();
        }

        function filterLiveBySearch() {
            filterLiveByClass();
        }

        function toggleAutoRefresh() {
            isAutoRefreshEnabled = !isAutoRefreshEnabled;
            const btn = document.getElementById('auto-refresh-btn');
            
            if (isAutoRefreshEnabled) {
                btn.innerText = 'Stop Auto-Refresh';
                btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                btn.classList.add('bg-red-600', 'hover:bg-red-700');
                
                autoRefreshInterval = setInterval(() => {
                    refreshLiveData();
                }, 10000); // Refresh every 10 seconds - only shows toast on NEW data
            } else {
                btn.innerText = 'Start Auto-Refresh';
                btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
                
                if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            }
        }

        function openCarManagement() {
            if (!isSOSSchool) {
                showToast('Car management is only available for SOS school.', 'error');
                return;
            }
            document.getElementById('choice-step').classList.add('hidden');
            document.getElementById('car-management-step').classList.remove('hidden');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('car-visit-date').value = today;
            loadCarManagementData();
        }

        async function loadCarManagementData() {
            const visitType = document.getElementById('car-visit-type').value;
            const visitDate = document.getElementById('car-visit-date').value;
            const list = document.getElementById('car-management-list');
            list.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-blue-500">Loading...</td></tr>';

            try {
                const res = await fetch(`/${schoolName}/admin/car-management?visit_type=${encodeURIComponent(visitType)}&visit_date=${encodeURIComponent(visitDate)}`);
                const result = await res.json();
                if (result.status !== 'success') {
                    list.innerHTML = `<tr><td colspan="6" class="px-6 py-8 text-center text-red-500">${result.message || 'Error loading data'}</td></tr>`;
                    return;
                }
                carManagementData = result.records || [];
                renderCarManagementTable();
            } catch (err) {
                console.error(err);
                list.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-red-500">Connection error.</td></tr>';
            }
        }

        function renderCarManagementTable() {
            const list = document.getElementById('car-management-list');
            if (!carManagementData.length) {
                list.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-400">No visit records found for this date/type.</td></tr>';
                return;
            }
            list.innerHTML = '';

            carManagementData.forEach((record) => {
                const movementLabel = record.movement_method === 'with_car'
                    ? 'By private car'
                    : record.movement_method === 'without_car'
                        ? 'Without car'
                        : '-';
                const row = document.createElement('tr');
                row.className = 'hover:bg-amber-50 transition';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm font-semibold text-gray-900">${record.student_name}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${record.class_name}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${movementLabel}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${record.arrival_plate_number || '-'}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${record.assigned_plate_number || '-'}</td>
                    <td class="px-4 py-3 text-sm">
                        <div class="flex gap-2">
                            <input id="assign-plate-${record.visit_id}" type="text" placeholder="Plate no." value="${record.assigned_plate_number || ''}" class="border rounded px-2 py-1 text-sm w-36">
                            <button onclick="assignCarPlate(${record.visit_id})" class="bg-amber-600 text-white px-3 py-1 rounded hover:bg-amber-700 font-semibold">Assign</button>
                        </div>
                    </td>
                `;
                list.appendChild(row);
            });
        }

        async function assignCarPlate(visitId) {
            const input = document.getElementById(`assign-plate-${visitId}`);
            const plate = (input?.value || '').trim();
            if (!plate) {
                showToast('Enter a plate number before assigning.', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('visit_id', String(visitId));
            formData.append('assigned_plate_number', plate);

            try {
                const res = await fetch(`/${schoolName}/admin/car-management/assign`, {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();
                if (result.status === 'success') {
                    showToast('Car plate assigned.', 'success');
                    await loadCarManagementData();
                } else {
                    showToast(result.message || 'Failed to assign plate.', 'error');
                }
            } catch (err) {
                console.error(err);
                showToast('Connection error while assigning plate.', 'error');
            }
        }
    </script>
</body>
</html>
